
<h2>任务列表</h2>

<!--
    <div>
      <select id="year" class="">
        {{#each years}}
        <option>{{this}}</option>
        {{/each}}
      </select>
      <select id="month" class="">
        {{#each months}}
        <option>{{this}}</option>
        {{/each}}
      </select>
      <a href=""></a>
    </div>
    -->
<div class="row">
  <div class="col-sm-6">
    <button type="button" class="btn btn-primary" data-toggle="button">增加</button>
  </div>
  <div class='col-sm-6'>
    <div class="form-group">
      <div class='input-group date' id='datetimepicker2'>
        <input type='text' class="form-control" />
        <span class="input-group-addon">
          <span class="glyphicon glyphicon-calendar"></span>
        </span>
      </div>
    </div>
  </div>
  <script type="text/javascript">
    $(function () {
    $('#datetimepicker2').datetimepicker({
    locale: 'zh-cn',
    format: 'YYYY-MM-DD',
    calendarWeeks: true
    });
    });
  </script>
</div>

<div class="table-responsive">
  <table class="table table-striped table-bordered table-hover">
    <tr>
      <th style="display:none;">ID</th>
      <th>工作类型</th>
      <th>工作任务</th>
      <th>工作内容</th>
      <th>达成情况</th>
      <th>用时</th>
      <th>操作</th>
    </tr>
    {{#each reviews}}
    <tr>
      <td style="display:none;">{{_id}}</td>
      <td>{{catalog}}</td>
      <td>{{task}}</td>
      <td>{{content}}</td>
      <td>{{progress}}</td>
      <td>{{cost}}</td>
      <td><a href="javascript:;" class="btn edit btn-info">修改</a>
        <a href="javascript:;" class="btn delete btn-info">删除</a></td>
    </tr>
    {{/each}}
  </table>
</div>

<script type="text/javascript">
  //增加
  $(".btn-primary").click(function(){
    if($("table tr").hasClass("add-tr") || $("table tr").hasClass("edit-tr")){
      alert("先完成操作！！！");
  }else{
  $("table tr:last").after('<tr class="add-tr">'
    + '<td style="display:none;"></td>'
    + '<td><input type="text" name="catalog" value="" /></td>'
    + '<td><input type="text" name="task" value="" /></td>'
    + '<td><input type="text" name="content" value="" /></td>'
    + '<td><input type="text" name="progress" value="" /></td>'
    + '<td><input type="text" name="cost" value="" /></td>'
    + '<td><a href="javascript:;" class="btn save btn-info">保存</a> '
      + '<a href="javascript:;" class="btn off btn-info">取消</api/users> </td>'
    + '</tr>');
  }
  })

  //保存
  $(document).on("click",".save",function(){
  var _id = $('input[name="_id"]').val();
  var catalog = $(this).parent().parent().find('input[name="catalog"]').val();
  var task = $('input[name="task"]').val();
  var content = $('input[name="content"]').val();
  var progress = $('input[name="progress"]').val();
  var cost = $('input[name="cost"]').val();

  if (_id) {
  $.ajax({
    type: "PUT",
    url: "/reviews/" + _id,
    data: {catalog: catalog, task: task, content: content, progress: progress, cost: cost},
    dataType: "json",
    success: function(data){
      console.log(data);
    }
  });

}
else {
  $.ajax({
    type: "POST",
    url: "/reviews/",
    data: {catalog: catalog, task: task, content: content, progress: progress, cost: cost},
    dataType: "json",
    success: function(data){
      console.log(data);
    }
  });
  
}

  var n = '';
  n += '<td style="display:none;">' + _id + '</td>'
  n += '<td>' + catalog + '</td>';
  n += '<td>' + task + '</td>';
  n += '<td>' + content + '</td>';
  n += '<td>' + progress + '</td>';
  n += '<td>' + cost + '</td>';

  n += '<td>';
  n += '<a href="javascript:;" class="btn edit btn-info"><span class="icon-edit"></span>修改</a> ';
  n += '<a href="javascript:;" class="btn delete btn-info"><span class="icon-delete"></span>删除</a>';
  n += '</td>';
  $(this).parent().parent().removeClass("add-tr edit-tr");
  $(this).parent().parent().html(n);
  })

  var old_id = "";
  var old_catalog = "";
  var old_task = "";
  var old_content = "";
  var old_progress = "";
  var old_cost = "";

  //修改
  $(document).on("click",".edit",function() {
  if($("table tr").hasClass("add-tr") || $("table tr").hasClass("edit-tr")) {
  alert("先完成操作！！！");
  }else{
  var _id = old_id = $(this).parent().parent().find('td').eq(0).text();
  var catalog = old_catalog = $(this).parent().parent().find('td').eq(1).text();
  var task = old_task = $(this).parent().parent().find('td').eq(2).text();
  var content = old_content = $(this).parent().parent().find('td').eq(3).text();
  var progress = old_progress = $(this).parent().parent().find('td').eq(4).text();
  var cost = old_cost = $(this).parent().parent().find('td').eq(5).text();

  var n = "";
  n += '<td style="display:none;"><input type="hidden" name="_id" value="' + _id + '" /></td>';
  n += '<td><input type="text" name="catalog" value="' + catalog + '" /></td>';
  n += '<td><input type="text" name="task" value="' + task + '" /></td>';
  n += '<td><input type="text" name="content" value="' + content + '" /></td>';
  n += '<td><input type="text" name="progress" value="' + progress + '" /></td>';
  n += '<td><input type="text" name="cost" value="' + cost + '" /></td>';
  n += '<td>';
  n += '<a href="javascript:;" class="btn save btn-info">保存</a> ';
  n += '<a href="javascript:;" class="btn off btn-info">取消</a>';
  n += '</td>';

  $(this).parent().parent().addClass("edit-tr");
  $(this).parent().parent().html(n);
  }

  })

  $(document).on("click",".off",function(){
  if ($("table tr").hasClass("edit-tr")) {
  var n = "";
  n += '<td style="display:none">' + old_id + '</td>';
  n += '<td>' + old_catalog + '</td>';
  n += '<td>' + old_task + '</td>';
  n += '<td>' + old_content + '</td>';
  n += '<td>' + old_progress + '</td>';
  n += '<td>' + old_cost + '</td>';
  n += '<td>';
  n += '<a href="javascript:;" class="btn edit btn-info"><span class="icon-edit"></span>修改</a> ';
  n += '<a href="javascript:;" class="btn delete btn-info"><span class="icon-edit"></span>删除</a>';
  n += '</td>';

  $(this).parent().parent().removeClass("edit-tr");
  $(this).parent().parent().html(n);
  }
  else {
    $(this).parent().parent().remove();
  }

  //  window.location.reload();
  })

$(document).on("click", ".delete", function() {
  var _id = $(this).parent().parent().find('td').eq(0).text();

  $.ajax({
    type: "DELETE",
    url: "/reviews/" + _id,
    data: {},
    success: function(data){
      console.log(data);
    }
  });

  $(this).parent().parent().remove();
})

</script>
